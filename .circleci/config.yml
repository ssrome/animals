version: 2.1

orbs:
  node: circleci/node@5.0.2
  cypress: cypress-io/cypress@1
  jest: blimmer/jest@1.1.0

workflows:
  jobs:
    - cypress/run:
        build: npm run build
        start: npm run start
        wait-on: "http://localhost:3000"
    - jest/test
    - deploy:
        requires:
          - cypress/run
          - jest/test
    # - deploy_preview:
    #     requires:
    #       - cypress/run
    #       - jest/test
    #     filters:
    #       branches:
    #         ignore:
    #           - main
    # - deploy_production:
    #     requires:
    #       - cypress/run
    #       - jest/test
    #     filters:
    #       branches:
    #         only:
    #           - main

jobs:
  deploy:
    docker:
      - image: cimg/deploy:2022.08
    steps:
      - run:
          name: deploy
          command: |
            if [ $CIRCLE_BRANCH == "main" ]; then
            npm install --global vercel \
            vercel pull --yes --environment=production --token=$VERCEL_TOKEN \
            vercel build --prod --token=$VERCEL_TOKEN \
            vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN \

            else
            npm install --global vercel \
            vercel pull --yes --environment=preview --token=$VERCEL_TOKEN \
            vercel build --token=$VERCEL_TOKEN \
            vercel deploy --prebuilt  --token=$VERCEL_TOKEN \
