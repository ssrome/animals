version: 2.1

orbs:
  node: circleci/node@5.0.2
  cypress: cypress-io/cypress@1
  jest: blimmer/jest@1.1.0
  docker: circleci/docker@2.1.3

workflows:
  version: 2
  jobs:
    - cypress/run:
        build: npm run build
        start: npm run start
        wait-on: "http://localhost:3000"
    - jest/test
    - pull-images:
        executor: docker/machine
        steps:
          - checkout
          - docker/pull:
              images: "ubuntu:16.04,ubuntu:18.04"
    - deploy_preview:
        requires:
          - cypress/run
          - jest/test
        filters:
          branches:
            ignore:
              - main
    - deploy_production:
        requires:
          - cypress/run
          - jest/test
        filters:
          branches:
            only:
              - main

jobs:
  deploy_preview:
    deploy:
      steps:
        - run: npm install --global vercel
            vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
            vercel build --token=$VERCEL_TOKEN
            vercel deploy --prebuilt  --token=$VERCEL_TOKEN

  deploy_production:
    deploy:
      steps:
        - run: npm install --global vercel
            vercel pull --yes --environment=production --token=$VERCEL_TOKEN
            vercel build --prod --token=$VERCEL_TOKEN
            vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
